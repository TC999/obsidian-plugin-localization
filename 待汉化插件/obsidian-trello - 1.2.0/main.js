"use strict";var e=require("obsidian"),t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,n)};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function n(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r=function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function i(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{l(r.next(e))}catch(e){o(e)}}function a(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((r=r.apply(e,t||[])).next())}))}function o(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function s(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function a(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function l(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}function c(e){return this instanceof c?(this.v=e,this):new c(e)}function u(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),o=[];return r={},s("next"),s("throw"),s("return"),r[Symbol.asyncIterator]=function(){return this},r;function s(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=i[e](t)).value instanceof c?Promise.resolve(n.value.v).then(l,u):d(o[0][2],n)}catch(e){d(o[0][3],e)}var n}function l(e){a("next",e)}function u(e){a("throw",e)}function d(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}}function d(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=s(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){(function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)})(r,i,(t=e[n](t)).done,t.value)}))}}}function h(e){return"function"==typeof e}function p(e){var t=e((function(e){Error.call(e),e.stack=(new Error).stack}));return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var f=p((function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}}));function g(e,t){if(e){var n=e.indexOf(t);0<=n&&e.splice(n,1)}}var v=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._teardowns=null}var t;return e.prototype.unsubscribe=function(){var e,t,n,r,i;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var c=s(o),u=c.next();!u.done;u=c.next()){u.value.remove(this)}}catch(t){e={error:t}}finally{try{u&&!u.done&&(t=c.return)&&t.call(c)}finally{if(e)throw e.error}}else o.remove(this);var d=this.initialTeardown;if(h(d))try{d()}catch(e){i=e instanceof f?e.errors:[e]}var p=this._teardowns;if(p){this._teardowns=null;try{for(var g=s(p),v=g.next();!v.done;v=g.next()){var b=v.value;try{y(b)}catch(e){i=null!=i?i:[],e instanceof f?i=l(l([],a(i)),a(e.errors)):i.push(e)}}}catch(e){n={error:e}}finally{try{v&&!v.done&&(r=g.return)&&r.call(g)}finally{if(n)throw n.error}}}if(i)throw new f(i)}},e.prototype.add=function(t){var n;if(t&&t!==this)if(this.closed)y(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._teardowns=null!==(n=this._teardowns)&&void 0!==n?n:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&g(t,e)},e.prototype.remove=function(t){var n=this._teardowns;n&&g(n,t),t instanceof e&&t._removeParent(this)},e.EMPTY=((t=new e).closed=!0,t),e}(),b=v.EMPTY;function m(e){return e instanceof v||e&&"closed"in e&&h(e.remove)&&h(e.add)&&h(e.unsubscribe)}function y(e){h(e)?e():e.unsubscribe()}var w={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},C={setTimeout:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=C.delegate;return((null==n?void 0:n.setTimeout)||setTimeout).apply(void 0,l([],a(e)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function x(e){C.setTimeout((function(){throw e}))}function E(){}function S(e){e()}var T=function(e){function t(t){var n=e.call(this)||this;return n.isStopped=!1,t?(n.destination=t,m(t)&&t.add(n)):n.destination=A,n}return n(t,e),t.create=function(e,t,n){return new L(e,t,n)},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(v),L=function(e){function t(t,n,r){var i,o=e.call(this)||this;if(h(t))i=t;else if(t){var s;i=t.next,n=t.error,r=t.complete,o&&w.useDeprecatedNextContext?(s=Object.create(t)).unsubscribe=function(){return o.unsubscribe()}:s=t,i=null==i?void 0:i.bind(s),n=null==n?void 0:n.bind(s),r=null==r?void 0:r.bind(s)}return o.destination={next:i?k(i):E,error:k(null!=n?n:P),complete:r?k(r):E},o}return n(t,e),t}(T);function k(e,t){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{e.apply(void 0,l([],a(t)))}catch(e){x(e)}}}function P(e){throw e}var A={closed:!0,next:E,error:P,complete:E},I="function"==typeof Symbol&&Symbol.observable||"@@observable";function D(e){return e}function _(e){return 0===e.length?D:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var O=function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r,i=this,o=(r=e)&&r instanceof T||function(e){return e&&h(e.next)&&h(e.error)&&h(e.complete)}(r)&&m(r)?e:new L(e,t,n);return S((function(){var e=i,t=e.operator,n=e.source;o.add(t?t.call(o,n):n?i._subscribe(o):i._trySubscribe(o))})),o},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},e.prototype.forEach=function(e,t){var n=this;return new(t=B(t))((function(t,r){var i;i=n.subscribe((function(t){try{e(t)}catch(e){r(e),null==i||i.unsubscribe()}}),r,t)}))},e.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},e.prototype[I]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return _(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=B(e))((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function B(e){var t;return null!==(t=null!=e?e:w.Promise)&&void 0!==t?t:Promise}function M(e){return function(t){if(function(e){return h(null==e?void 0:e.lift)}(t))return t.lift((function(t){try{return e(t,this)}catch(e){this.error(e)}}));throw new TypeError("Unable to lift unknown Observable type")}}var N=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.onFinalize=o,s._next=n?function(e){try{n(e)}catch(e){t.error(e)}}:e.prototype._next,s._error=i?function(e){try{i(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,s._complete=r?function(){try{r()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,s}return n(t,e),t.prototype.unsubscribe=function(){var t,n=this.closed;e.prototype.unsubscribe.call(this),!n&&(null===(t=this.onFinalize)||void 0===t||t.call(this))},t}(T),j=p((function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})),R=function(e){function t(){var t=e.call(this)||this;return t.closed=!1,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return n(t,e),t.prototype.lift=function(e){var t=new $(this,this);return t.operator=e,t},t.prototype._throwIfClosed=function(){if(this.closed)throw new j},t.prototype.next=function(e){var t=this;S((function(){var n,r;if(t._throwIfClosed(),!t.isStopped){var i=t.observers.slice();try{for(var o=s(i),a=o.next();!a.done;a=o.next()){a.value.next(e)}}catch(e){n={error:e}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}}}))},t.prototype.error=function(e){var t=this;S((function(){if(t._throwIfClosed(),!t.isStopped){t.hasError=t.isStopped=!0,t.thrownError=e;for(var n=t.observers;n.length;)n.shift().error(e)}}))},t.prototype.complete=function(){var e=this;S((function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}}))},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return(null===(e=this.observers)||void 0===e?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var t=this,n=t.hasError,r=t.isStopped,i=t.observers;return n||r?b:(i.push(e),new v((function(){return g(i,e)})))},t.prototype._checkFinalizedStatuses=function(e){var t=this,n=t.hasError,r=t.thrownError,i=t.isStopped;n?e.error(r):i&&e.complete()},t.prototype.asObservable=function(){var e=new O;return e.source=this,e},t.create=function(e,t){return new $(e,t)},t}(O),$=function(e){function t(t,n){var r=e.call(this)||this;return r.destination=t,r.source=n,r}return n(t,e),t.prototype.next=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===n||n.call(t,e)},t.prototype.error=function(e){var t,n;null===(n=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===n||n.call(t,e)},t.prototype.complete=function(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)},t.prototype._subscribe=function(e){var t,n;return null!==(n=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==n?n:b},t}(R),F=function(e){function t(t){var n=e.call(this)||this;return n._value=t,n}return n(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(t){var n=e.prototype._subscribe.call(this,t);return!n.closed&&t.next(this._value),n},t.prototype.getValue=function(){var e=this,t=e.hasError,n=e.thrownError,r=e._value;if(t)throw n;return this._throwIfClosed(),r},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t}(R),V=new O((function(e){return e.complete()}));function U(e,t){return new O((function(n){var r=0;return t.schedule((function(){r===e.length?n.complete():(n.next(e[r++]),n.closed||this.schedule())}))}))}var H=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function q(e){return h(null==e?void 0:e.then)}var z="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function Q(e,t){if(!e)throw new Error("Iterable cannot be null");return new O((function(n){var r=new v;return r.add(t.schedule((function(){var i=e[Symbol.asyncIterator]();r.add(t.schedule((function(){var e=this;i.next().then((function(t){t.done?n.complete():(n.next(t.value),e.schedule())}))})))}))),r}))}function G(e){return h(e[I])}function W(e){return h(null==e?void 0:e[z])}function Y(e){return Symbol.asyncIterator&&h(null==e?void 0:e[Symbol.asyncIterator])}function X(e){return new TypeError("You provided "+(null!==e&&"object"==typeof e?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function J(e){return u(this,arguments,(function(){var t,n,r;return o(this,(function(i){switch(i.label){case 0:t=e.getReader(),i.label=1;case 1:i.trys.push([1,,9,10]),i.label=2;case 2:return[4,c(t.read())];case 3:return n=i.sent(),r=n.value,n.done?[4,c(void 0)]:[3,5];case 4:return[2,i.sent()];case 5:return[4,c(r)];case 6:return[4,i.sent()];case 7:return i.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}}))}))}function Z(e){return h(null==e?void 0:e.getReader)}function K(e,t){if(null!=e){if(G(e))return function(e,t){return new O((function(n){var r=new v;return r.add(t.schedule((function(){var i=e[I]();r.add(i.subscribe({next:function(e){r.add(t.schedule((function(){return n.next(e)})))},error:function(e){r.add(t.schedule((function(){return n.error(e)})))},complete:function(){r.add(t.schedule((function(){return n.complete()})))}}))}))),r}))}(e,t);if(H(e))return U(e,t);if(q(e))return function(e,t){return new O((function(n){return t.schedule((function(){return e.then((function(e){n.add(t.schedule((function(){n.next(e),n.add(t.schedule((function(){return n.complete()})))})))}),(function(e){n.add(t.schedule((function(){return n.error(e)})))}))}))}))}(e,t);if(Y(e))return Q(e,t);if(W(e))return function(e,t){return new O((function(n){var r;return n.add(t.schedule((function(){r=e[z](),function(e,t,n,r){void 0===r&&(r=0);var i=t.schedule((function(){try{n.call(this)}catch(t){e.error(t)}}),r);e.add(i)}(n,t,(function(){var e=r.next(),t=e.value;e.done?n.complete():(n.next(t),this.schedule())}))}))),function(){return h(null==r?void 0:r.return)&&r.return()}}))}(e,t);if(Z(e))return function(e,t){return Q(J(e),t)}(e,t)}throw X(e)}function ee(e,t){return t?K(e,t):te(e)}function te(e){if(e instanceof O)return e;if(null!=e){if(G(e))return r=e,new O((function(e){var t=r[I]();if(h(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")}));if(H(e))return ne(e);if(q(e))return n=e,new O((function(e){n.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,x)}));if(Y(e))return re(e);if(W(e))return t=e,new O((function(e){var n,r;try{for(var i=s(t),o=i.next();!o.done;o=i.next()){var a=o.value;if(e.next(a),e.closed)return}}catch(e){n={error:e}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}e.complete()}));if(Z(e))return re(J(e))}var t,n,r;throw X(e)}function ne(e){return new O((function(t){for(var n=0;n<e.length&&!t.closed;n++)t.next(e[n]);t.complete()}))}function re(e){return new O((function(t){(function(e,t){var n,r,s,a;return i(this,void 0,void 0,(function(){var i,l;return o(this,(function(o){switch(o.label){case 0:o.trys.push([0,5,6,11]),n=d(e),o.label=1;case 1:return[4,n.next()];case 2:if((r=o.sent()).done)return[3,4];if(i=r.value,t.next(i),t.closed)return[2];o.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return l=o.sent(),s={error:l},[3,11];case 6:return o.trys.push([6,,9,10]),r&&!r.done&&(a=n.return)?[4,a.call(n)]:[3,8];case 7:o.sent(),o.label=8;case 8:return[3,10];case 9:if(s)throw s.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}}))}))})(e,t).catch((function(e){return t.error(e)}))}))}function ie(e,t){return t?U(e,t):ne(e)}function oe(e){return e[e.length-1]}function se(e){return h(oe(e))?e.pop():void 0}function ae(e){return(t=oe(e))&&h(t.schedule)?e.pop():void 0;var t}function le(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=ae(e);return n?U(e,n):ie(e)}function ce(e,t){var n=h(e)?e:function(){return e},r=function(e){return e.error(n())};return new O(t?function(e){return t.schedule(r,0,e)}:r)}function ue(e,t){return M((function(n,r){var i=0;n.subscribe(new N(r,(function(n){r.next(e.call(t,n,i++))})))}))}var de=Array.isArray;function he(e){return ue((function(t){return function(e,t){return de(t)?e.apply(void 0,l([],a(t))):e(t)}(e,t)}))}var pe,fe,ge,ve,be,me,ye,we=Array.isArray,Ce=Object.getPrototypeOf,xe=Object.prototype,Ee=Object.keys;function Se(e){if(1===e.length){var t=e[0];if(we(t))return{args:t,keys:null};if((r=t)&&"object"==typeof r&&Ce(r)===xe){var n=Ee(t);return{args:n.map((function(e){return t[e]})),keys:n}}}var r;return{args:e,keys:null}}function Te(e,t){return e.reduce((function(e,n,r){return e[n]=t[r],e}),{})}function Le(e,t,n){return void 0===n&&(n=D),function(r){ke(t,(function(){for(var i=e.length,o=new Array(i),s=i,a=i,l=function(i){ke(t,(function(){var l=ee(e[i],t),c=!1;l.subscribe(new N(r,(function(e){o[i]=e,c||(c=!0,a--),a||r.next(n(o.slice()))}),(function(){--s||r.complete()})))}),r)},c=0;c<i;c++)l(c)}),r)}}function ke(e,t,n){e?n.add(e.schedule(t)):t()}function Pe(e,t,n){return void 0===n&&(n=1/0),h(t)?Pe((function(n,r){return ue((function(e,i){return t(n,e,r,i)}))(te(e(n,r)))}),n):("number"==typeof t&&(n=t),M((function(t,r){return function(e,t,n,r,i,o,s,a){var l=[],c=0,u=0,d=!1,h=function(){!d||l.length||c||t.complete()},p=function(e){return c<r?f(e):l.push(e)},f=function(e){o&&t.next(e),c++;var a=!1;te(n(e,u++)).subscribe(new N(t,(function(e){null==i||i(e),o?p(e):t.next(e)}),(function(){a=!0}),void 0,(function(){if(a)try{c--;for(var e=function(){var e=l.shift();s?t.add(s.schedule((function(){return f(e)}))):f(e)};l.length&&c<r;)e();h()}catch(e){t.error(e)}})))};return e.subscribe(new N(t,p,(function(){d=!0,h()}))),function(){null==a||a()}}(t,r,e,n)})))}function Ae(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=se(e),r=Se(e),i=r.args,o=r.keys,s=new O((function(e){var t=i.length;if(t)for(var n=new Array(t),r=t,s=t,a=function(t){var a=!1;te(i[t]).subscribe(new N(e,(function(e){a||(a=!0,s--),n[t]=e}),(function(){--r&&a||(s||e.next(o?Te(o,n):n),e.complete())})))},l=0;l<t;l++)a(l);else e.complete()}));return n?s.pipe(he(n)):s}function Ie(e,t,n){return r=function(){return e()?t:n},new O((function(e){te(r()).subscribe(e)}));var r}function De(e,t){return M((function(n,r){var i=0;n.subscribe(new N(r,(function(n){return e.call(t,n,i++)&&r.next(n)})))}))}function _e(e){return M((function(t,n){var r,i=null,o=!1;i=t.subscribe(new N(n,void 0,void 0,(function(s){r=te(e(s,_e(e)(t))),i?(i.unsubscribe(),i=null,r.subscribe(n)):o=!0}))),o&&(i.unsubscribe(),i=null,r.subscribe(n))}))}function Oe(e,t){return h(t)?Pe(e,t,1):Pe(e,1)}function Be(e){return e<=0?function(){return V}:M((function(t,n){var r=0;t.subscribe(new N(n,(function(t){++r<=e&&(n.next(t),e<=r&&n.complete())})))}))}function Me(e){return M((function(t,n){try{t.subscribe(n)}finally{n.add(e)}}))}function Ne(e,t){return M((function(n,r){var i=null,o=0,s=!1,a=function(){return s&&!i&&r.complete()};n.subscribe(new N(r,(function(n){null==i||i.unsubscribe();var s=0,l=o++;te(e(n,l)).subscribe(i=new N(r,(function(e){return r.next(t?t(n,e,l,s++):e)}),(function(){i=null,a()})))}),(function(){s=!0,a()})))}))}function je(e){return M((function(t,n){te(e).subscribe(new N(n,(function(){return n.complete()}),E)),!n.closed&&t.subscribe(n)}))}function Re(e,t,n){var r=h(e)||t||n?{next:e,error:t,complete:n}:e;return r?M((function(e,t){var n;null===(n=r.subscribe)||void 0===n||n.call(r);var i=!0;e.subscribe(new N(t,(function(e){var n;null===(n=r.next)||void 0===n||n.call(r,e),t.next(e)}),(function(){var e;i=!1,null===(e=r.complete)||void 0===e||e.call(r),t.complete()}),(function(e){var n;i=!1,null===(n=r.error)||void 0===n||n.call(r,e),t.error(e)}),(function(){var e,t;i&&(null===(e=r.unsubscribe)||void 0===e||e.call(r)),null===(t=r.finalize)||void 0===t||t.call(r)})))})):D}!function(e){e.NoToken="NoToken",e.Unauthorized="Unauthorized",e.RateLimit="RateLimit",e.Unknown="Unknown",e.Abort="Abort"}(pe||(pe={})),function(e){e.Left="left",e.Right="right"}(fe||(fe={})),function(e){e.Comment="commentCard"}(ge||(ge={})),function(e){e.Complete="complete",e.Incomplete="incomplete"}(ve||(ve={})),function(e){e.Green="green",e.Yellow="yellow",e.Orange="orange",e.Red="red",e.Purple="purple",e.Blue="blue",e.Sky="sky",e.Lime="lime",e.Pink="pink",e.Black="black"}(be||(be={})),function(e){e.Top="top",e.Bottom="bottom"}(me||(me={})),function(e){e[e.Info=0]="Info",e[e.Warn=1]="Warn",e[e.Error=2]="Error"}(ye||(ye={}));const $e={id:"trello-plugin-icon-trello",svgContent:'<g><path fill="currentColor" stroke="currentColor" style="stroke:none;fill-rule:nonzero;fill-opacity:1;" d="M 82 8 L 18 8 C 12.480469 8 8 12.480469 8 18 L 8 82 C 8 87.519531 12.480469 92 18 92 L 82 92 C 87.519531 92 92 87.519531 92 82 L 92 18 C 92 12.480469 87.519531 8 82 8 Z M 42 72 C 42 74.199219 40.199219 76 38 76 L 24 76 C 21.800781 76 20 74.199219 20 72 L 20 24 C 20 21.800781 21.800781 20 24 20 L 38 20 C 40.199219 20 42 21.800781 42 24 Z M 80 48 C 80 50.199219 78.199219 52 76 52 L 62 52 C 59.800781 52 58 50.199219 58 48 L 58 24 C 58 21.800781 59.800781 20 62 20 L 76 20 C 78.199219 20 80 21.800781 80 24 Z M 80 48 "/></g>'},Fe="https://api.trello.com",Ve="The Trello plugin requires an API token for use. Please visit plugin settings.",Ue="The Trello API is rate limited. Please try again later.",He="The Trello plugin requires the MetaEdit plugin.",qe="The Trello API rejected your token. Please create a new token.",ze="The Trello API could not be reached. Please create a new token or try again later.",Qe={token:"",selectedBoards:[],openToSide:fe.Right,newCardPosition:me.Top,movedCardPosition:me.Top,verboseLogging:!1},Ge={settings:Qe,version:"1.2.0",firstRun:!0};var We;!function(e){e.BoardCard="trello_board_card_id"}(We||(We={}));const Ye={name:"Create a new card...",id:"CREATE_NEW_TRELLO_CARD"};function Xe(e){switch(e.responseType){case"json":if("response"in e)return e.response;var t=e;return JSON.parse(t.responseText);case"document":return e.responseXML;case"text":default:return"response"in e?e.response:(t=e).responseText}}var Je=function(e,t,n,r){void 0===r&&(r="download_load"),this.originalEvent=e,this.xhr=t,this.request=n,this.type=r;var i=t.status,o=t.responseType;this.status=null!=i?i:0,this.responseType=null!=o?o:"";var s=t.getAllResponseHeaders();this.responseHeaders=s?s.split("\n").reduce((function(e,t){var n=t.indexOf(": ");return e[t.slice(0,n)]=t.slice(n+2),e}),{}):{},this.response=Xe(t);var a=e.loaded,l=e.total;this.loaded=a,this.total=l},Ze=p((function(e){return function(e,t,n){var r;this.message=e,this.name="AjaxError",this.xhr=t,this.request=n,this.status=t.status,this.responseType=t.responseType;try{r=Xe(t)}catch(e){r=t.responseText}this.response=r}})),Ke=function(){function e(e,t){return Ze.call(this,"ajax timeout",e,t),this.name="AjaxTimeoutError",this}return e.prototype=Object.create(Ze.prototype),e}();function et(e,t){return lt({method:"GET",url:e,headers:t})}function tt(e,t,n){return lt({method:"POST",url:e,body:t,headers:n})}function nt(e,t){return lt({method:"DELETE",url:e,headers:t})}function rt(e,t,n){return lt({method:"PUT",url:e,body:t,headers:n})}function it(e,t,n){return lt({method:"PATCH",url:e,body:t,headers:n})}var ot=ue((function(e){return e.response}));function st(e,t){return ot(lt({method:"GET",url:e,headers:t}))}var at,lt=((at=function(e){return function(e){return new O((function(t){var n,i,o,s=e.queryParams,a=e.body,l=e.headers,c=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(e,["queryParams","body","headers"]),u=c.url;if(!u)throw new TypeError("url is required");if(s)if(u.includes("?")){var d=u.split("?");if(2<d.length)throw new TypeError("invalid url");o=new URLSearchParams(d[1]),new URLSearchParams(s).forEach((function(e,t){return o.set(t,e)})),u=d[0]+"?"+o}else u=u+"?"+(o=new URLSearchParams(s));var h={};if(l)for(var p in l)l.hasOwnProperty(p)&&(h[p.toLowerCase()]=l[p]);e.crossDomain||"x-requested-with"in h||(h["x-requested-with"]="XMLHttpRequest");var f=c.withCredentials,g=c.xsrfCookieName,v=c.xsrfHeaderName;if((f||!c.crossDomain)&&g&&v){var b=null!==(i=null===(n=null===document||void 0===document?void 0:document.cookie.match(new RegExp("(^|;\\s*)("+g+")=([^;]*)")))||void 0===n?void 0:n.pop())&&void 0!==i?i:"";b&&(h[v]=b)}var m,y=function(e,t){var n;if(!e||"string"==typeof e||function(e){return"undefined"!=typeof FormData&&e instanceof FormData}(e)||function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams}(e)||function(e){return pt(e,"ArrayBuffer")}(e)||function(e){return pt(e,"File")}(e)||function(e){return pt(e,"Blob")}(e)||function(e){return"undefined"!=typeof ReadableStream&&e instanceof ReadableStream}(e))return e;if(function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(e)}(e))return e.buffer;if("object"==typeof e)return t["content-type"]=null!==(n=t["content-type"])&&void 0!==n?n:"application/json;charset=utf-8",JSON.stringify(e);throw new TypeError("Unknown body type")}(a,h),w=r(r({async:!0,crossDomain:!0,withCredentials:!1,method:"GET",timeout:0,responseType:"json"},c),{url:u,headers:h,body:y});m=e.createXHR?e.createXHR():new XMLHttpRequest;var C=e.progressSubscriber,x=e.includeDownloadProgress,E=void 0!==x&&x,S=e.includeUploadProgress,T=void 0!==S&&S,L=function(e,n){m.addEventListener(e,(function(){var e,r=n();null===(e=null==C?void 0:C.error)||void 0===e||e.call(C,r),t.error(r)}))};L("timeout",(function(){return new Ke(m,w)})),L("abort",(function(){return new Ze("aborted",m,w)}));var k=function(e,t){return new Je(t,m,w,e+"_"+t.type)},P=function(e,n,r){e.addEventListener(n,(function(e){t.next(k(r,e))}))};T&&[ct,ut,dt].forEach((function(e){return P(m.upload,e,"upload")})),C&&[ct,ut].forEach((function(e){return m.upload.addEventListener(e,(function(e){var t;return null===(t=null==C?void 0:C.next)||void 0===t?void 0:t.call(C,e)}))})),E&&[ct,ut].forEach((function(e){return P(m,e,"download")}));var A=function(e){var n="ajax error"+(e?" "+e:"");t.error(new Ze(n,m,w))};m.addEventListener("error",(function(e){var t;null===(t=null==C?void 0:C.error)||void 0===t||t.call(C,e),A()})),m.addEventListener(dt,(function(e){var n,r,i=m.status;if(i<400){null===(n=null==C?void 0:C.complete)||void 0===n||n.call(C);var o=void 0;try{o=k("download",e)}catch(e){return void t.error(e)}t.next(o),t.complete()}else null===(r=null==C?void 0:C.error)||void 0===r||r.call(C,e),A(i)}));var I=w.user,D=w.method,_=w.async;for(var p in I?m.open(D,u,_,I,w.password):m.open(D,u,_),_&&(m.timeout=w.timeout,m.responseType=w.responseType),"withCredentials"in m&&(m.withCredentials=w.withCredentials),h)h.hasOwnProperty(p)&&m.setRequestHeader(p,h[p]);return y?m.send(y):m.send(),function(){m&&4!==m.readyState&&m.abort()}}))}("string"==typeof e?{url:e}:e)}).get=et,at.post=tt,at.delete=nt,at.put=rt,at.patch=it,at.getJSON=st,at),ct="loadstart",ut="progress",dt="load";var ht=Object.prototype.toString;function pt(e,t){return ht.call(e)==="[object "+t+"]"}class ft{constructor(e){this.plugin=e,this.token=new F(""),this.plugin.state.settings.pipe(je(this.plugin.destroy),ue((e=>e.token))).subscribe(this.token)}getBoards(){if(this.plugin.log("API - getBoards"),""===this.token.value)return ce((()=>pe.NoToken));const e=this.auth(`${Fe}/1/members/me/boards?fields=name,url`);return lt({url:e,crossDomain:!0}).pipe(_e((e=>this.handleAPIError(e))),ue((e=>e.response)))}getCardFromBoard(e,t,n=!1,r=12e4){this.plugin.log("API - getCardFromBoard");const i=this.plugin.state.cardCache[t];return!i||n||(new Date).getTime()-i.timestamp.getTime()>r?this._getCardFromBoard(e,t):(this.plugin.log("-> Returning cached value."),le(i.item))}_getCardFromBoard(e,t){if(""===this.token.value)return ce((()=>pe.NoToken));const n=this.auth(`${Fe}/1/boards/${e}/cards/${t}`);return lt({url:n,crossDomain:!0}).pipe(_e((e=>this.handleAPIError(e))),ue((e=>e.response)),Re((e=>{e&&(this.plugin.state.cardCache[e.id]={item:e,timestamp:new Date})})))}getLabelsFromBoard(e,t=!1,n=6e5){this.plugin.log("API - getLabelsFromBoard");const r=this.plugin.state.labelCache[e];return!r||t||(new Date).getTime()-r.timestamp.getTime()>n?this._getLabelsFromBoard(e):(this.plugin.log("-> Returning cached value."),le(r.item))}_getLabelsFromBoard(e){if(""===this.token.value)return ce((()=>pe.NoToken));const t=this.auth(`${Fe}/1/boards/${e}/labels`);return lt({url:t,crossDomain:!0}).pipe(_e((e=>this.handleAPIError(e))),ue((e=>e.response)),Re((t=>{this.plugin.state.labelCache[e]={item:t,timestamp:new Date}})))}getListsFromBoard(e){if(this.plugin.log("API - getListsFromBoard"),""===this.token.value)return ce((()=>pe.NoToken));const t=this.auth(`${Fe}/1/boards/${e}/lists`);return lt({url:t,crossDomain:!0}).pipe(_e((e=>this.handleAPIError(e))),ue((e=>e.response)),Re((e=>{e&&e.length>0&&e.forEach((e=>{this.plugin.state.listCache[e.id]={item:e,timestamp:new Date}}))})))}getList(e,t=!1,n=6e5){this.plugin.log("API - getList");const r=this.plugin.state.listCache[e];return!r||t||(new Date).getTime()-r.timestamp.getTime()>n?this._getList(e):(this.plugin.log("-> Returning cached value."),le(r.item))}_getList(e){if(""===this.token.value)return ce((()=>pe.NoToken));const t=this.auth(`${Fe}/1/lists/${e}`);return lt({url:t,crossDomain:!0}).pipe(_e((e=>this.handleAPIError(e))),ue((e=>e.response)),Re((e=>{e&&(this.plugin.state.listCache[e.id]={item:e,timestamp:new Date})})))}getCardsFromBoard(e){if(this.plugin.log("API - getCardsFromBoard"),""===this.token.value)return ce((()=>pe.NoToken));const t=this.auth(`${Fe}/1/boards/${e}/cards`);return lt({url:t,crossDomain:!0}).pipe(_e((e=>this.handleAPIError(e))),ue((e=>e.response)),Re((e=>{e.forEach((e=>{this.plugin.state.cardCache[e.id]={item:e,timestamp:new Date}}))})))}getActionsFromCard(e,t=[ge.Comment],n=!1,r=6e4){this.plugin.log("API - getActionsFromCard");const i=this.plugin.state.cardActionsCache[e];return!i||n||(new Date).getTime()-i.timestamp.getTime()>r?this._getActionsFromCard(e,t):(this.plugin.log("-> Returning cached value."),le(i.item))}_getActionsFromCard(e,t=[ge.Comment]){if(""===this.token.value)return ce((()=>pe.NoToken));const n=this.auth(`${Fe}/1/cards/${e}/actions?filter=${t.join(",")}`);return lt({url:n,crossDomain:!0}).pipe(_e((e=>this.handleAPIError(e))),ue((e=>e.response)),Re((t=>{t&&(this.plugin.state.cardActionsCache[e]={item:t,timestamp:new Date})})))}addCommentToCard(e,t){if(this.plugin.log("API - addCommentToCard"),""===this.token.value)return ce((()=>pe.NoToken));const n=this.auth(`${Fe}/1/cards/${e}/actions/comments?text=${encodeURIComponent(t)}`);return lt({url:n,method:"POST",crossDomain:!0}).pipe(_e((e=>this.handleAPIError(e))))}addNewCard(e){if(this.plugin.log("API - addNewCard"),""===this.token.value)return ce((()=>pe.NoToken));let t=this.auth(`${Fe}/1/cards`);return t=this.addQueryParam(t,"idList",e.idList),t=this.addQueryParam(t,"name",e.name,!0),t=this.addQueryParam(t,"desc",e.desc,!0),t=this.addQueryParam(t,"pos",e.pos),t=this.addQueryParam(t,"idLabels",e.idLabels?e.idLabels.join(","):void 0),lt({url:t,method:"POST",crossDomain:!0}).pipe(_e((e=>this.handleAPIError(e))))}updateCardList(e,t,n=me.Top){return this.plugin.log("API - updateCardList"),this.updateCard({id:e,idList:t})}updateCard(e){if(this.plugin.log("API - updateCard"),""===this.token.value)return ce((()=>pe.NoToken));let t=this.auth(`${Fe}/1/cards/${e.id}`);return t=this.addQueryParam(t,"name",e.name,!0),t=this.addQueryParam(t,"desc",e.desc,!0),t=this.addQueryParam(t,"idBoard",e.idBoard),t=this.addQueryParam(t,"idList",e.idList),t=this.addQueryParam(t,"due",e.due),t=this.addQueryParam(t,"idAttachmentCover",e.idAttachmentCover),e.idLabels&&(t=this.addQueryParam(t,"idLabels",e.idLabels.join(","))),void 0!==e.dueComplete&&(t=this.addQueryParam(t,"dueComplete",e.dueComplete.toString())),lt({url:t,method:"PUT",crossDomain:!0}).pipe(_e((e=>this.handleAPIError(e))),ue((e=>e.response)))}auth(e){return`${e}${e.includes("?")?"&":"?"}key=9537467993aefd6dca9ee7788179c298&token=${this.token.value}`}addQueryParam(e,t,n,r=!1){return n?`${e}${e.includes("?")?"&":"?"}${t}=${r?encodeURIComponent(n):n}`:e}handleAPIError(e){return ce((()=>{if(!(e instanceof Ze))return pe.Unknown;switch(e.status){case 401:return pe.Unauthorized;case 429:return pe.RateLimit;default:return pe.Unknown}}))}}class gt extends e.SuggestModal{constructor(e){super(e),this.selected=new R,this.options=[],this.selectionMade=!1}onOpen(){this.selectionMade=!1,super.onOpen()}onClose(){this.selectionMade||(this.selected.error(pe.Abort),this.selected.complete(),this.selected=new R),super.onClose()}selectSuggestion(e,t){this.selectionMade=!0,super.selectSuggestion(e,t)}onChooseSuggestion(e){this.selected.next(e),this.selected.complete(),this.selected=new R}}class vt extends gt{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello board"}])}getSuggestions(e){const t=e.toLowerCase();return this.options.filter((e=>e.name.toLowerCase().includes(t)))}renderSuggestion(e,t){t.setText(e.name)}}class bt extends gt{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello card"}])}getSuggestions(e){const t=e.toLowerCase();return[Ye,...this.options.filter((e=>e.name.toLowerCase().includes(t)))]}renderSuggestion(e,t){t.setText(e.name)}}class mt extends e.Modal{constructor(e,t){super(t),this.plugin=e,this.selectedBoards=this.plugin.state.settings.pipe(Be(1),ue((e=>e.selectedBoards?e.selectedBoards:[]))),this.newState={}}onOpen(){this.contentEl.empty(),Ae({selected:this.selectedBoards,boards:this.plugin.api.getBoards()}).subscribe({next:({selected:e,boards:t})=>{const n=this.contentEl.createDiv("trello-board-select--container");n.createEl("h2",{text:"Boards",cls:"trello-board-select--title"}),this.newState={},e.forEach((e=>{this.newState[e.id]=e})),t.forEach((e=>{this.buildToggle(e,n)}));const r=this.contentEl.createDiv("trello-board-select--controls");r.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",(()=>{this.onSave()}));r.createEl("button",{text:"Cancel"}).addEventListener("click",(()=>{this.close()}))},error:()=>{if(this.plugin.state.currentToken.value&&""!==this.plugin.state.currentToken.value)new e.Notice(ze),this.close();else{this.contentEl.createDiv({cls:"trello-board-select--empty-state",text:"An API token is required."}).createEl("button",{text:"Setup Trello"}).addEventListener("click",(()=>{this.plugin.openTrelloSettings(),this.close()}))}}})}onClose(){this.contentEl.empty()}buildToggle(e,t){const n=t.createDiv("trello-board-select--toggle-container");n.createDiv({text:e.name,cls:"trello-board-select--toggle-label"});const r=n.createDiv({cls:"trello-board-select--toggle checkbox-container"});this.newState[e.id]&&r.addClass("is-enabled"),n.addEventListener("click",(()=>{this.newState[e.id]?(r.removeClass("is-enabled"),delete this.newState[e.id]):(r.addClass("is-enabled"),this.newState[e.id]=e)}))}onSave(){const e=Object.values(this.newState);this.plugin.state.updateSetting("selectedBoards",e),this.close()}}class yt{constructor(e,t=!0){this.parent=e,this.openOne=t,this.sections=[]}addSection(t){const n=this.parent.createDiv("trello-accordion--container"),r=n.createDiv("trello-accordion--title");r.createSpan({text:t,cls:"trello-accordion--title-text"});const i=r.createSpan("trello-accordion--title-icon");e.setIcon(i,"left-chevron-glyph");const o=n.createDiv("trello-accordion--content"),s={containerEl:n,titleEl:r,titleIcon:i,contentEl:o,expanded:!1};return s.titleEl.addEventListener("click",(()=>{s.expanded?this.collapseSection(s):this.expandSection(s)})),this.sections.push(s),s}expandSection(e){this.openOne&&this.sections.forEach((t=>{t!==e&&this.collapseSection(t)})),e.expanded=!0,e.titleIcon.addClass("trello-accordion--expanded"),e.contentEl.style.maxHeight=e.contentEl.scrollHeight+"px"}collapseSection(e){e.expanded=!1,e.titleIcon.removeClass("trello-accordion--expanded"),e.contentEl.style.maxHeight=""}}class wt extends e.Modal{constructor(e,t){super(e),this.plugin=t,this.labels=[],this.createdCard=new R,this.selectedLabels={},this.finishedCardCreation=!1}onOpen(){this.contentEl.empty();const e=this.contentEl.createDiv();this.title=this.renderTitle(e);const t=new yt(e),n=t.addSection("Description"),r=t.addSection("Labels");this.description=this.renderDescription(n.contentEl),this.renderLabels(r.contentEl),this.position=this.renderPositionSelect(e);const i=e.createDiv("trello-card-create--controls");i.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",this.onSave.bind(this));i.createEl("button",{text:"Cancel"}).addEventListener("click",this.close.bind(this))}onClose(){this.finishedCardCreation||this.createdCard.error(pe.Abort),this.reset()}onSave(){this.plugin.api.addNewCard({idList:this.list.id,idLabels:Object.values(this.selectedLabels).map((e=>e.id)),name:this.title.value,desc:this.description.value,pos:this.position.value}).pipe(ue((e=>e.response))).subscribe({next:e=>{this.finishedCardCreation=!0,this.createdCard.next(e),this.close()},error:e=>{this.finishedCardCreation=!0,this.createdCard.error(e)}})}reset(){this.selectedLabels={},this.createdCard=new R,this.title.value="",this.description.value="",this.finishedCardCreation=!1}renderTitle(e){return e.createEl("input",{cls:"trello-card-create--title",attr:{placeholder:"Enter a title for this card..."}})}renderDescription(e){return e.createDiv("trello-card-create--desc-wrapper").createDiv({cls:"trello-card-create--desc-container"}).createEl("textarea",{cls:"trello-card-create--desc",attr:{onInput:"this.parentNode.dataset.replicatedValue = this.value",placeholder:"Add a more detailed description..."}})}renderLabels(e){const t=e.createDiv("trello-card-create--labels");this.labels.forEach((e=>{this.renderLabel(e,t)}))}renderLabel(e,t){const n=t.createDiv("trello-card-create--label-container");e.color?n.addClass(`label-color--${e.color}`):n.addClass("label-color--grey"),n.createSpan({text:e.name,cls:"trello-card-create--label-name"}),this.buildCheck(e,n)}buildCheck(t,n){const r=n.createSpan({cls:"trello-card-create--check"});n.addEventListener("click",(()=>{this.selectedLabels[t.id]?(r.empty(),delete this.selectedLabels[t.id]):(e.setIcon(r,"checkbox-glyph",20),this.selectedLabels[t.id]=t)}))}renderPositionSelect(e){const t=e.createDiv("trello-card-create--position-select-container");t.createEl("label",{text:"Add new card to",attr:{for:"trello-card-create--position-select"}});const n=t.createEl("select",{cls:"dropdown",attr:{id:"trello-card-create--position-select"}});return n.createEl("option",{text:"Top",attr:{value:me.Top}}),n.createEl("option",{text:"Bottom",attr:{value:me.Bottom}}),n.value=this.defaultPosition,n}}class Ct extends gt{constructor(e){super(e),this.setInstructions([{command:"",purpose:"Select a Trello list"}])}getSuggestions(e){const t=e.toLowerCase();return this.options.filter((e=>e.name.toLowerCase().includes(t)))}renderSuggestion(e,t){t.setText(e.name)}}class xt extends e.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t,this.boardSelectModal=new mt(this.plugin,this.plugin.app)}display(){return i(this,void 0,void 0,(function*(){this.plugin.log("Initializing settings"),this.containerEl.empty(),this.containerEl.createEl("h2",{text:"Obsidian Trello settings."}),this.plugin.state.settings.pipe(Be(1)).subscribe((e=>{this.buildTokenSetting(this.containerEl,e),this.buildBoardSelectSetting(this.containerEl),this.buildOpenToSideSetting(this.containerEl,e),this.buildNewCardPositionSetting(this.containerEl,e),this.buildMovedCardPositionSetting(this.containerEl,e),this.buildVerboseLoggingSetting(this.containerEl,e)}))}))}buildTokenSetting(t,n){return i(this,void 0,void 0,(function*(){this.plugin.log(`-> Adding token setting with initial value ${n.token}`);const r=new DocumentFragment;r.createDiv({cls:"setting-item-description"}).innerHTML='Your API token. <a href="https://trello.com/1/authorize?expiration=never&scope=read,write&response_type=token&name=Obsidian%20Trello%20Token&key=9537467993aefd6dca9ee7788179c298">Generate one</a> then copy it here. This token can be revoked at any time in your Trello account settings.',new e.Setting(t).setName("Trello Token").setDesc(r).addText((e=>{e.setPlaceholder("Enter token").setValue(n.token).onChange((e=>{this.plugin.state.updateSetting("token",e.trim())}))}))}))}buildBoardSelectSetting(t){this.plugin.log("-> Adding board select setting"),new e.Setting(t).setName("Select Boards").setDesc("These boards will be available to select cards from.").addButton((e=>{e.setButtonText("Select").onClick((()=>{this.boardSelectModal.open()}))}))}buildOpenToSideSetting(t,n){this.plugin.log(`-> Adding open to side setting with initial value ${n.openToSide}`),new e.Setting(t).setName("Open to Side").setDesc("Whether the Trello pane should open to the left or right side.").addDropdown((e=>{e.addOption(fe.Right,"Right").addOption(fe.Left,"Left").setValue(n.openToSide).onChange((e=>{this.plugin.state.updateSetting("openToSide",e)}))}))}buildNewCardPositionSetting(t,n){this.plugin.log(`-> Adding new card position setting with initial value ${n.newCardPosition}`),new e.Setting(t).setName("New Card Position").setDesc("Whether newly created cards should be added to the top or bottom of the list by default. Can be overridden when adding a card.").addDropdown((e=>{e.addOption(me.Top,"Top").addOption(me.Bottom,"Bottom").setValue(n.newCardPosition).onChange((e=>{this.plugin.state.updateSetting("newCardPosition",e)}))}))}buildMovedCardPositionSetting(t,n){this.plugin.log(`-> Adding moved card position setting with initial value ${n.movedCardPosition}`),new e.Setting(t).setName("Moved Card Position").setDesc("When moving a card from one list to another, should it be moved to the top or bottom of the selected list.").addDropdown((e=>{e.addOption(me.Top,"Top").addOption(me.Bottom,"Bottom").setValue(n.movedCardPosition).onChange((e=>{this.plugin.state.updateSetting("movedCardPosition",e)}))}))}buildVerboseLoggingSetting(t,n){this.plugin.log(`-> Adding verbose logging setting with initial value ${n.verboseLogging}`),new e.Setting(t).setName("Verbose Logging").setDesc("Enable this if you're having trouble with the plugin. Logs will be enabled in the console.").addToggle((e=>{e.setValue(n.verboseLogging).onChange((e=>{this.plugin.state.updateSetting("verboseLogging",e)}))}))}}class Et{constructor(e,t){this.plugin=e,this.cardCache={},this.cardActionsCache={},this.listCache={},this.labelCache={},this.boardCardId=new F(null),this.currentToken=new F(""),this.verboseLogging=new F(!1),this.data=new F(t),this.data.pipe(je(e.destroy)).subscribe((e=>i(this,void 0,void 0,(function*(){yield this.plugin.saveData(e)}))))}get settings(){return this.data.pipe(ue((e=>e.settings)))}updateSetting(e,t){const n=Object.assign({},this.data.value.settings);n[e]=t,this.data.next(Object.assign(Object.assign({},this.data.value),{settings:n}))}completedFirstRun(){this.data.next(Object.assign(Object.assign({},this.data.value),{firstRun:!1}))}}class St{constructor(e,t,n){this.plugin=e,this.destroy=t,this.update=n,this.bypassActionCache=!1,this.bypassListCache=!1,this.cardError=null,this.actionsError=null,this.listError=null,this.currentCard=new F(null),this.currentActions=new F(null),this.currentList=new F(null),this.plugin.state.boardCardId.pipe(je(this.destroy),Re((e=>{e||(this.cardError=null,this.actionsError=null,this.listError=null,this.currentCard.next(null),this.currentActions.next(null),this.currentList.next(null))})),De((e=>null!==e&&""!==e)),Ne((e=>{this.plugin.log(`View Manager - Got new board/card ID ${e}`),this.plugin.log("-> Getting card from API/cache.");const[t,n]=e.split(";");return this.plugin.api.getCardFromBoard(t,n)}))).subscribe({next:e=>{null!==this.currentCard.value&&this.currentCard.value.id!==e.id&&(this.plugin.log("View Manager - Card changed, resetting extra info."),this.currentActions.next(null),this.currentList.next(null)),this.cardError=null,this.plugin.log("-> Card updated."),this.currentCard.next(e)},error:e=>{this.cardError=e,this.currentCard.next(null)}}),this.currentCard.pipe(je(this.destroy),De((e=>null!==e)),Ne((e=>this.plugin.api.getActionsFromCard(e.id,void 0,this.bypassActionCache))),Me((()=>{this.bypassActionCache=!1}))).subscribe({next:e=>{this.plugin.log("View Manager - Actions updated."),this.actionsError=null,this.currentActions.next(e)},error:e=>{this.actionsError=e,this.currentActions.next(null)}}),this.currentCard.pipe(je(this.destroy),De((e=>null!==e)),Ne((e=>this.plugin.api.getList(e.idList,this.bypassListCache))),Me((()=>{this.bypassListCache=!1}))).subscribe({next:e=>{this.plugin.log("View Manager - List updated."),this.listError=null,this.currentList.next(e)},error:e=>{this.listError=e,this.currentList.next(null)}}),this.update.pipe(je(this.destroy),De((()=>null!==this.currentCard.value)),Re((()=>{this.plugin.log("View Manager - Refreshing data."),this.bypassActionCache=!0,this.bypassListCache=!0})),Ne((()=>{const e=this.currentCard.value;return this.plugin.api.getCardFromBoard(e.idBoard,e.id,!0)}))).subscribe({next:e=>{this.cardError=null,e&&(this.plugin.log("-> Got updated card."),this.currentCard.next(e))},error:e=>{this.cardError=e,this.currentCard.next(null)}})}moveCard(){if(this.currentCard.value&&this.currentList.value){this.plugin.log("View Manager - Beginning move card flow");const e=this.currentCard.value,t=this.currentList.value;Ae({list:this.plugin.api.getListsFromBoard(e.idBoard).pipe(ue((e=>{this.plugin.log("-> Marking current list.");const n=e.find((e=>e.id===t.id));return n&&(n.name=`${n.name} (current list)`),e})),Oe((e=>(this.plugin.log("-> Got all lists for board."),this.plugin.listSuggestModal.options=e,this.plugin.listSuggestModal.open(),this.plugin.listSuggestModal.selected))),Be(1),Re((e=>{this.plugin.log(`-> Selected list ${e.id}. Updating card.`)}))),position:this.plugin.state.settings.pipe(Be(1),ue((e=>e.movedCardPosition)),Re((e=>{this.plugin.log(`-> Moved card position: ${e}`)})))}).pipe(Oe((({list:t,position:n})=>this.plugin.api.updateCardList(e.id,t.id,n)))).subscribe({next:e=>{this.plugin.log("-> Updated card."),this.currentCard.next(e)},error:e=>{pe.Abort}})}}}class Tt extends e.ItemView{constructor(e,t){super(t),this.plugin=e,this.destroy=new R,this.update=new R,this.viewManager=new St(this.plugin,this.destroy,this.update),function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=ae(e),r=se(e),i=Se(e),o=i.args,s=i.keys;if(0===o.length)return ee([],n);var a=new O(Le(o,n,s?function(e){return Te(s,e)}:D));return r?a.pipe(he(r)):a}([this.viewManager.currentCard,this.viewManager.currentActions,this.viewManager.currentList]).pipe(je(this.destroy)).subscribe((([e,t,n])=>{this.contentEl.empty();const r=[this.viewManager.cardError,this.viewManager.actionsError,this.viewManager.listError];r.some((e=>null!==e))?this.renderEmptyView(this.getWorstError(r)):null===e?this.renderEmptyView(null):this.renderConnectedView(e,t,n)}))}getDisplayText(){return"Trello"}getViewType(){return"trello-plugin"}getIcon(){return $e.id}onunload(){this.destroy.next(),this.destroy.complete()}renderPaneContainer(){return this.contentEl.createDiv("trello-pane--container")}renderEmptyView(e){this.plugin.log("Rendering empty view.");const t=this.renderPaneContainer();if(null===e||e===pe.NoToken)if(t.createEl("h2",{text:"No Trello card connected."}),e===pe.NoToken){t.createDiv({text:"An API token is required."});t.createEl("button",{text:"Setup Trello",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.openTrelloSettings()}))}else{t.createEl("button",{text:"Connect Trello Card",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.connectTrelloCard()}))}else if(t.createEl("h2",{text:"Could not reach Trello API."}),e===pe.RateLimit)t.createDiv({text:Ue});else if(e===pe.Unauthorized){t.createDiv({text:qe});t.createEl("button",{text:"Setup Trello",attr:{type:"button"}}).addEventListener("click",(()=>{this.plugin.openTrelloSettings()}))}else t.createDiv({text:ze})}renderConnectedView(e,t,n){this.renderHeader(this.contentEl);const r=this.renderPaneContainer(),i=r.createDiv("trello-pane--card-info");if(this.renderCardInfo(e,n,i),e.labels&&e.labels.length>0){const t=r.createDiv("trello-pane--label-section");this.renderLabels(e,t)}const o=r.createDiv("trello-pane--comment-section");this.renderCommentSection(e,t,o)}renderHeader(e){const t=e.createDiv("nav-header").createDiv("nav-buttons-container");this.renderNavButton(t,"Refresh card","reset",(()=>{this.update.next()})),this.renderNavButton(t,"Link another card","link",(()=>{this.plugin.connectTrelloCard()})),this.renderNavButton(t,"Unlink card","trash",(()=>{this.plugin.disconnectTrelloCard()}))}renderCardInfo(t,n,r){if(n){const t=r.createEl("a",{cls:"trello-pane--card-info--list",text:n.name,attr:{"aria-label":"Move card",href:"#"}}),i=t.createSpan();e.setIcon(i,"right-arrow-with-tail"),t.addEventListener("click",(()=>{this.viewManager.moveCard()}))}const i=r.createEl("h3",{text:t.name}).createEl("a",{attr:{href:t.url,"aria-label":"View on Trello"}});e.setIcon(i,"navigate-glyph",24);const o=r.createDiv("trello-card-desc--container"),s=o.createEl("a",{text:"Description",cls:"trello-card-desc--collapse",href:"#"}),a=s.createSpan("trello-card-desc--collapse-icon");e.setIcon(a,"down-chevron-glyph");const l=o.createDiv({text:t.desc,cls:"trello-card-desc--desc"});s.addEventListener("click",(()=>{l.style.maxHeight?(l.style.maxHeight="",e.setIcon(a,"down-chevron-glyph")):(l.style.maxHeight=l.scrollHeight+"px",e.setIcon(a,"up-chevron-glyph"))}))}renderLabels(e,t){e.labels.forEach((e=>{e.color&&t.createSpan({cls:`trello-label trello-color--${e.color}`,attr:{"aria-label":""!==e.name?e.name:null}})}))}renderCommentSection(t,n,r){const i=r.createDiv("trello-comment-input--container"),o=i.createDiv({cls:"trello-comment-input--input-container"}).createEl("textarea",{cls:"trello-comment-input--input",attr:{onInput:"this.parentNode.dataset.replicatedValue = this.value",placeholder:"Write a comment..."}});i.createEl("button",{cls:"trello-comment-input--submit",text:"Submit",attr:{type:"button"}}).addEventListener("click",(()=>{o.value&&this.plugin.api.addCommentToCard(t.id,o.value).pipe(Re((()=>{o.value=""}))).subscribe((()=>{this.update.next(),new e.Notice("Added comment.")}))})),n&&0!==n.length&&n.forEach((e=>{this.renderComment(e,r)}))}renderComment(e,t){const n=t.createDiv("trello-comment--container"),r=n.createDiv("trello-comment--metadata");r.createSpan({text:e.memberCreator.fullName,cls:"trello-comment--creator"}),r.createSpan({text:new Date(e.date).toLocaleString(),cls:"trello-comment--date"});n.createDiv("trello-comment--text-container").createEl("p",{text:e.data.text,cls:"trello-comment--text"})}renderNavButton(t,n,r,i){const o=t.createDiv({cls:"nav-action-button",attr:{"aria-label":n}});e.setIcon(o,r),o.addEventListener("click",i)}getWorstError(e){let t=null;return e.forEach((e=>{switch(t){case null:case pe.NoToken:null!==e&&(t=e);break;case pe.RateLimit:e===pe.Unauthorized&&(t=e)}})),t}}class Lt extends e.Plugin{constructor(){super(...arguments),this.destroy=new R,this.boardSuggestModal=new vt(this.app),this.listSuggestModal=new Ct(this.app),this.cardSuggestModal=new bt(this.app),this.cardCreateModal=new wt(this.app,this)}get metaEditAvailable(){const t=!!this.app.plugins.plugins.metaedit;return t||(this.log("MetaEdit not available.",ye.Error),new e.Notice(He)),t}get metaEdit(){return Object.assign(Object.assign({},this.app.plugins.plugins.metaedit.api),{deleteProperty:this.deleteProperty.bind(this)})}onload(){return i(this,void 0,void 0,(function*(){const t=yield this.loadData(),n=Object.assign({},Ge,t);n.settings=Object.assign({},Qe,null==t?void 0:t.settings),this.state=new Et(this,n),this.api=new ft(this),e.addIcon($e.id,$e.svgContent),this.state.settings.pipe(je(this.destroy)).subscribe((e=>{this.state.currentToken.next(e.token),this.state.verboseLogging.next(e.verboseLogging)})),this.registerView("trello-plugin",(e=>this.view=new Tt(this,e))),this.registerEvent(this.app.workspace.on("file-open",(e=>i(this,void 0,void 0,(function*(){return this.handleFile(e)}))))),this.handleFile(this.app.workspace.getActiveFile()),this.addSettingTab(new xt(this.app,this)),this.addCommand({id:"trello-plugin-connect-card",name:"Connect Trello card",callback:this.connectTrelloCard.bind(this),icon:"link"}),this.addCommand({id:"trello-plugin-disconnect-card",name:"Disconnect Trello card",callback:this.disconnectTrelloCard.bind(this),icon:"trash"}),this.addCommand({id:"trello-plugin-reveal-leaf",name:"Show Trello view",callback:()=>{this.revealTrelloLeaf(!0)},icon:$e.id}),n.firstRun&&(this.revealTrelloLeaf(!0),this.state.completedFirstRun())}))}onunload(){this.destroy.next(),this.destroy.complete(),this.app.workspace.detachLeavesOfType("trello-plugin")}openTrelloSettings(){this.log("Opening settings"),this.app.setting.openTabById("obsidian-trello"),this.app.setting.open()}log(e,t=ye.Info){if(this.state.verboseLogging.value){const n=`OBISIDAN-TRELLO: ${e}`;switch(t){case ye.Warn:console.warn(n);break;case ye.Error:console.error(n);break;case ye.Info:default:console.log(n)}}}handleFile(e){return i(this,void 0,void 0,(function*(){if(!e||!this.metaEditAvailable)return;const t=yield this.metaEdit.getPropertyValue(We.BoardCard,e);if(!t)return this.log("File not trello connected"),void this.state.boardCardId.next(null);this.log(`File trello connected, board/card ID ${t}`),this.state.boardCardId.next(t)}))}updateOrCreateMeta(e,t,n){return ee(this.metaEdit.getPropertyValue(e,n)).pipe(Oe((r=>ee(r?this.metaEdit.update(e,t,n):this.metaEdit.createYamlProperty(e,t,n)))))}connectTrelloCard(){var t;const n=null===(t=this.app.workspace.activeLeaf)||void 0===t?void 0:t.view;let r;n instanceof e.FileView&&this.metaEditAvailable&&(this.log("Connecting trello card"),this.state.settings.pipe(Be(1),ue((e=>e.selectedBoards)),Oe((e=>Ie((()=>e.length>0),le(e),this.api.getBoards()))),Re((()=>{this.log("-> Got boards")})),Oe((e=>this.selectBoard(e))),Re((e=>{this.log(`-> Selected board ${e.id}`),r=e})),Oe((e=>this.api.getCardsFromBoard(e.id))),Re((e=>{this.log(`-> Got ${e.length} cards.`)})),Oe((e=>this.selectCard(e))),Re((e=>{this.log(`-> Selected card ${e.id}`)})),Oe((e=>Ie((()=>e===Ye),this.addNewCard(r),le(e)))),ue((e=>`${e.idBoard};${e.id}`)),Re((e=>{this.log(`-> Updating file with board/card ID ${e}`),this.state.boardCardId.next(e)})),Oe((e=>this.updateOrCreateMeta(We.BoardCard,e,n.file)))).subscribe({next:()=>{this.revealTrelloLeaf(!0)},error:t=>{t===pe.Abort?this.log("-> Aborting connect flow."):t===pe.Unauthorized?(this.log("-> API returned unauthorized.",ye.Error),new e.Notice(qe)):t===pe.RateLimit?(this.log("-> API returned rate limit error.",ye.Error),new e.Notice(Ue)):t===pe.NoToken?(this.log("-> No token present.",ye.Error),new e.Notice(Ve)):t===pe.Unknown&&(this.log("-> Caught unknown error.",ye.Error),new e.Notice(ze))}}))}disconnectTrelloCard(){var t;const n=null===(t=this.app.workspace.activeLeaf)||void 0===t?void 0:t.view;n instanceof e.FileView&&this.metaEditAvailable&&ee(this.metaEdit.getPropertyValue(We.BoardCard,n.file)).subscribe((e=>{e&&(this.log("Disconnecting trello connected card."),this.metaEdit.deleteProperty(We.BoardCard,n.file),this.state.boardCardId.next(null))}))}selectBoard(e){return this.boardSuggestModal.options=e,this.boardSuggestModal.open(),this.boardSuggestModal.selected.pipe(Be(1))}selectCard(e){return this.cardSuggestModal.options=e,this.cardSuggestModal.open(),this.cardSuggestModal.selected.pipe(Be(1))}addNewCard(e){return this.log("Beginning add new card flow."),Ae({labels:this.api.getLabelsFromBoard(e.id),list:this.api.getListsFromBoard(e.id).pipe(Oe((e=>(this.listSuggestModal.options=e,this.listSuggestModal.open(),this.listSuggestModal.selected))),Be(1)),settings:this.state.settings.pipe(Be(1))}).pipe(Oe((({labels:t,list:n,settings:r})=>(this.log("-> All add new card observables emitted, setting up card create modal."),this.cardCreateModal.board=e,this.cardCreateModal.list=n,this.cardCreateModal.labels=t,this.cardCreateModal.defaultPosition=r.newCardPosition,this.cardCreateModal.open(),this.cardCreateModal.createdCard))),Be(1))}revealTrelloLeaf(e=!1){this.log("Revealing trello leaf.");const t=this.app.workspace.getLeavesOfType("trello-plugin");0===t.length?(this.log("-> No trello leaf found, creating."),this.state.settings.pipe(Be(1),ue((e=>e.openToSide))).subscribe((t=>{this.log(`-> Creating leaf on ${t} side.`);const n=t===fe.Right?this.app.workspace.getRightLeaf(!1):this.app.workspace.getLeftLeaf(!1);n.setViewState({type:"trello-plugin"}),e&&(this.log("-> Leaf created, revealing."),this.app.workspace.revealLeaf(n))}))):e&&(this.log("-> Trello leaf found, revealing."),this.app.workspace.revealLeaf(t[0]))}deleteProperty(e,t){return i(this,void 0,void 0,(function*(){if(t){const n=(yield this.app.vault.read(t)).split("\n"),r=new RegExp(`^s*${e}:`),i=n.findIndex((e=>e.match(r))),o=n.filter(((e,t)=>{if(t!=i)return!0})).join("\n");yield this.app.vault.modify(t,o)}}))}}module.exports=Lt;
